---
date: 2025-01-19
topic: "架构概览"
version: 1.3.0
status: draft
---

# 架构概览

## 1. 项目背景

在 Kubernetes 环境下，中间件的部署和管理一直是一个复杂的挑战。每种中间件（Redis、Kafka、MySQL 等）都有其独特的部署方式、配置参数和运维需求。传统的做法是为每种中间件开发独立的 Operator，但这带来了重复工作、维护成本高、学习曲线陡峭等问题。

本项目旨在设计一个**通用的中间件管理平台**，通过插件化架构支持多种中间件的统一管理。

## 2. 项目目标

设计一个通用的中间件管理平台，具备以下核心能力：

| 能力 | 说明 |
|-----|------|
| **生命周期管理** | 部署、升级、扩缩容、删除 |
| **配置管理** | 参数配置、配置热更新 |
| **高可用** | 被动高可用（自动角色检测）+ 主动故障转移 |
| **备份恢复** | 统一备份框架，支持多种存储后端和加密 |
| **监控告警** | Prometheus 集成、可配置告警规则 |

## 3. 设计原则

1. **关注点分离**：App → Component → Group 三层职责分离
2. **插件化架构**：通过模板和配置驱动，新中间件无需编写代码
3. **热升级能力**：插件支持热升级，不中断服务
4. **Agent 双容器架构**：Agent 1 负责进程管理，Agent 2 负责工具调用

## 4. 全局元数据管理

平台为每个 App 维护独立的元数据（Middleware Metadata），记录该中间件实例的节点状态和配置信息。

### 4.1 元数据类型

| 类型 | 说明 | 更新时机 |
|-----|------|---------|
| **基本信息** | 插件版本、运行时版本、创建时间 | App 创建/更新时 |
| **节点状态** | normal/adding/deleting 列表 | Pod 增加/删除时 |
| **中间件配置** | 当前生效的配置参数 | 配置变更时 |

### 4.2 元数据存储

每个 App 对应一个独立的 ConfigMap，与 App 同命名空间：

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: <app-name>-metadata
  namespace: <app-namespace>
  ownerReferences:
    - apiVersion: middleware.io/v1alpha1
      kind: App
      name: <app-name>
```

### 4.3 详细设计

元数据管理的完整设计（包括存储结构、生命周期、权限管理等）请参阅 [全局元数据管理](./15-metadata-management.md)。

## 5. 控制器层概述

控制器层包含三个控制器，协同完成资源生命周期管理：

| 控制器 | 职责 | 监听资源 | 产出资源 |
|-------|------|---------|---------|
| **App Controller** | 顶层编排、元数据管理 | App | Component |
| **Component Controller** | 运行时分组管理 | Component | Group |
| **Group Controller** | 资源配置与 Pod 管理 | Group | K8s 资源 |

控制器详细功能说明请参阅 [控制器设计](./14-controller-design.md)。

## 6. 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    中间件管理平台架构                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  三层 CRD 架构                                           │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │  App (中间件实例)                                  │    │   │
│  │  │  ├── 绑定插件版本                                  │    │   │
│  │  │  ├── 指定运行时版本                                │    │   │
│  │  │  └── 可包含多个 Component                          │    │   │
│  │  │       │                                            │    │   │
│  │  │       ▼                                            │    │   │
│  │  │  ┌─────────────────────────────────────────┐      │    │   │
│  │  │  │  Component (运行时分组)                   │      │    │   │
│  │  │  │  └── 可包含多个 Group                     │      │    │   │
│  │  │  │       │                                  │      │    │   │
│  │  │  │       ▼                                  │      │    │   │
│  │  │  │  ┌─────────────────────────────────┐    │      │    │   │
│  │  │  │  │  Group (资源配置分组)             │    │      │    │   │
│  │  │  │  │  ├── 控制副本数                   │    │      │    │   │
│  │  │  │  │  ├── 定义资源规格                 │    │      │    │   │
│  │  │  │  │  └── 控制滚动升级                 │    │      │    │   │
│  │  │  │  └─────────────────────────────────┘    │      │    │   │
│  │  │  └─────────────────────────────────────────┘      │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  控制器层                                                │   │
│  │  ├── App Controller     (管理 App 资源)                  │   │
│  │  ├── Component Controller (管理 Component 资源)          │   │
│  │  └── Group Controller    (管理 Group 资源 + gRPC 调用)   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  插件系统                                                │   │
│  │  ├── Plugin ConfigMap (插件定义 + 默认值 + 模板引用)     │   │
│  │  └── Template ConfigMap (独立模板文件)                   │   │
│  │  模板格式：Go template 为主，CUE 为辅                    │   │
│  │  版本：支持热升级，相邻版本兼容相同运行时                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Kubernetes 资源层                                       │   │
│  │  ├── ConfigMap (用户配置)                                │   │
│  │  ├── Deployment (Pod 模板)                               │   │
│  │  ├── Service (网络)                                      │   │
│  │  └── PVC (持久存储)                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Pod 运行时                                             │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │  容器 1: Agent 1 + 中间件 (主容器，双进程)               │    │   │
│  │  │  ├── Agent 1 (PID 1，进程管理，端口 50051)      │    │   │
│  │  │  └── 中间件进程 (redis-server 等)               │    │   │
│  │  │                                                  │    │   │
│  │  │  端口: 6379 (业务), 端口: 50051 (gRPC)          │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                        │                                  │
│  │                        │ (共享卷)                         │
│  │                        ▼                                  │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │  容器 2: Agent 2 (辅助容器，关键组件)           │    │   │
│  │  │                                                  │    │   │
│  │  │  Agent 2 (工具调用，端口 50052)                  │    │   │
│  │  │  ├── Failover()     - 故障转移                  │    │   │
│  │  │  ├── GetRole()      - 角色检测                  │    │   │
│  │  │  └── ReloadConfig() - 配置热更新                │    │   │
│  │  │                                                  │    │   │
│  │  │  依赖: 容器 1 的进程状态                         │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                               │
│  │  共享卷:                                                      │
│  │  ├── /scripts (工具脚本)                                     │
│  │  └── /middleware (中间件数据/套接字)                          │
│  │                                                               │
│  └───────────────────────────────────────────────────────────────┘
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 7. 三层关系

```
App (中间件实例)
    │
    ├── Component (运行时分组，运行相同中间件进程)
    │   │
    │   └── Group (资源配置分组，相同规格的 Pod)
    │       │
    │       └── Pod
    │
    └── Component ...

示例1：production-redis（主从 + Sentinel 模式）
├── Component: redis-server (运行 redis-server)
│   └── Group: redis-group (2 Pods, 2C4G)
└── Component: redis-sentinel (运行 redis-sentinel)
    └── Group: sentinel-group (3 Pods, 1C1G)

示例2：production-kafka（集群模式）
├── Component: kafka-nodes (运行 kafka)
│   └── Group: broker-group (3 Pods, 4C8G)
└── Component: zookeeper-nodes (运行 zookeeper)
    └── Group: zookeeper-group (3 Pods, 1C2G)

示例3：单节点中间件
└── Component: mysql-node (运行 mysql)
    └── Group: primary-group (1 Pod, 2C4G)
```

## 8. 约束条件

### 6.1 非功能性约束

| 约束 | 要求 |
|-----|------|
| **Kubernetes 版本** | >= 1.20 |
| **存储要求** | 中间件数据存储需要持久卷，备份需要对象存储 |
| **网络要求** | 插件镜像可访问，支持 Service 发现 |
| **权限要求** | 需要创建 Deployment、Service、ConfigMap、PVC 等资源 |

### 6.2 架构约束

1. **不可变运行时**：相邻插件版本必须支持相同版本的中间件运行时
2. **Agent 架构**：Agent 1 + 中间件在同一容器，Agent 2 在另一个容器
3. **配置热更新**：Controller 主动调用 Agent gRPC 通知配置变更
4. **滚动升级**：中间件版本升级采用滚动升级方式

## 9. 文档导航

- 上一章：[README](./00-README.md)
- 下一章：[App CRD 规范](./02-crd-app.md)
- 相关文档：[全局元数据管理](./15-metadata-management.md)、[控制器设计](./14-controller-design.md)、[插件系统](./05-plugin-system.md)、[Agent 设计](./06-agent-design.md)

## 10. 版本历史

| 版本 | 日期 | 修改内容 |
|-----|------|---------|
| 1.0.0 | 2025-01-19 | 初始版本 |
| 1.1.0 | 2025-01-19 | 完善控制器层设计，添加 App Controller 元数据管理说明 |
| 1.2.0 | 2025-01-19 | 控制器详细设计移至独立文档 [14-controller-design.md](./14-controller-design.md) |
| 1.3.0 | 2025-01-19 | 全局元数据管理移至独立文档 [15-metadata-management.md](./15-metadata-management.md) |
